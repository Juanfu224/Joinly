# =============================================================================
# Joinly - Docker Compose Production
# =============================================================================
# Configuración completa para despliegue en producción
# Uso: docker compose -f docker-compose.prod.yml up -d
#
# Características:
#   - Red interna aislada
#   - Volúmenes persistentes
#   - Health checks en todos los servicios
#   - Restart policies
#   - Resource limits
#   - SSL con Let's Encrypt
# =============================================================================

services:
  # ===========================================================================
  # MySQL Database
  # ===========================================================================
  mysql:
    image: mysql:lts
    container_name: joinly-mysql-prod
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Europe/Madrid
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/mysql-init:/docker-entrypoint-initdb.d:ro
    networks:
      - joinly-internal
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    # No exponer puerto externamente en producción
    # ports:
    #   - "3306:3306"

  # ===========================================================================
  # Backend - Spring Boot API
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: joinly-backend:${APP_VERSION:-latest}
    container_name: joinly-backend-prod
    restart: always
    environment:
      # Spring profiles
      SPRING_PROFILES_ACTIVE: prod
      # Database
      DB_URL: jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Europe/Madrid
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      # JWT
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600000}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-2592000000}
      # Encryption
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      # CORS
      CORS_ALLOWED_ORIGIN: https://${DOMAIN}
      # Java options (ZGenerational solo en Java 21-23, removido en 24+)
      JAVA_OPTS: >-
        -XX:+UseZGC
        -Xms512m
        -Xmx1g
        -XX:+ExitOnOutOfMemoryError
        -Djava.security.egd=file:/dev/./urandom
      # Timezone
      TZ: Europe/Madrid
    volumes:
      - backend_logs:/app/logs
    networks:
      - joinly-internal
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 1.5G
        reservations:
          memory: 512M
    # No exponer puerto externamente (nginx hace proxy)
    # ports:
    #   - "8080:8080"

  # ===========================================================================
  # Frontend - Angular
  # ===========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: joinly-frontend:${APP_VERSION:-latest}
    container_name: joinly-frontend-prod
    restart: always
    environment:
      TZ: Europe/Madrid
    networks:
      - joinly-internal
    depends_on:
      - backend
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:4200/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
    # No exponer puerto externamente (nginx hace proxy)
    # ports:
    #   - "4200:4200"

  # ===========================================================================
  # Nginx - Reverse Proxy + SSL
  # ===========================================================================
  nginx:
    image: nginx:alpine
    container_name: joinly-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN}
      TZ: Europe/Madrid
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf.template:ro
      - ./nginx/nginx-initial.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/50x.html:/etc/nginx/html/50x.html:ro
      - certbot_conf:/etc/letsencrypt:ro
      - certbot_www:/var/www/certbot:ro
      - nginx_logs:/var/log/nginx
    networks:
      - joinly-internal
      - joinly-external
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M
    # Comando con substitución de variables y arranque
    entrypoint: /bin/sh
    command: >
      -c "envsubst '$$DOMAIN' < /etc/nginx/nginx.conf.template > /tmp/nginx.conf &&
          cp /tmp/nginx.conf /etc/nginx/nginx.conf &&
          nginx -t &&
          nginx -g 'daemon off;'"

  # ===========================================================================
  # Certbot - SSL Certificate Management
  # ===========================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: joinly-certbot
    restart: unless-stopped
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    depends_on:
      - nginx
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M
    # Renovar certificados cada 12 horas
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot -w /var/www/certbot --quiet; sleep 12h & wait $${!}; done;'"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql_data:
    name: joinly-mysql-data
  backend_logs:
    name: joinly-backend-logs
  nginx_logs:
    name: joinly-nginx-logs
  certbot_conf:
    name: joinly-certbot-conf
  certbot_www:
    name: joinly-certbot-www

# =============================================================================
# Networks
# =============================================================================
networks:
  # Red interna - solo comunicación entre servicios
  joinly-internal:
    name: joinly-internal
    driver: bridge
    internal: true
  # Red externa - acceso a internet (solo nginx)
  joinly-external:
    name: joinly-external
    driver: bridge
