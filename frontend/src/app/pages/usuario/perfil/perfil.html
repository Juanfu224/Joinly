<article class="p-perfil" aria-labelledby="perfil-titulo">
  <header class="p-perfil__header">
    <h1 id="perfil-titulo" class="p-perfil__titulo">Mi perfil</h1>
    <p class="p-perfil__descripcion">Gestiona tu información personal y preferencias de cuenta</p>
  </header>

  @if (!isEditing()) {
    <app-card class="p-perfil__card">
      <div class="p-perfil__content">
        <!-- Hero Section -->
        <section class="p-perfil__hero" aria-label="Información del usuario">
          <figure class="p-perfil__avatar-wrapper">
            <app-avatar
              [src]="usuario()?.avatar ?? ''"
              [name]="usuario()?.nombre ?? 'Usuario'"
              size="xl" />
          </figure>
          <div class="p-perfil__hero-info">
            <h2 class="p-perfil__nombre">{{ usuario()?.nombre ?? 'Usuario' }}</h2>
            <p class="p-perfil__email">{{ usuario()?.email ?? 'email@ejemplo.com' }}</p>
            @if (usuario()?.emailVerificado) {
              <span class="p-perfil__badge p-perfil__badge--verificado">
                <app-icon name="check" size="sm" aria-hidden="true" />
                Verificado
              </span>
            }
          </div>
          <div class="p-perfil__hero-actions">
            <app-button variant="primary" leftIcon="edit" (click)="onEdit()">
              Editar perfil
            </app-button>
          </div>
        </section>

        <!-- Información Personal -->
        <section class="p-perfil__section" aria-labelledby="info-titulo">
          <header class="p-perfil__section-header">
            <app-icon name="user" size="sm" aria-hidden="true" />
            <h3 id="info-titulo" class="p-perfil__section-titulo">Información personal</h3>
          </header>
          <dl class="p-perfil__data-grid">
            <div class="p-perfil__data-item">
              <dt>Nombre completo</dt>
              <dd>{{ usuario()?.nombre ?? 'No especificado' }}</dd>
            </div>
            <div class="p-perfil__data-item">
              <dt>Correo electrónico</dt>
              <dd>{{ usuario()?.email ?? 'No especificado' }}</dd>
            </div>
            <div class="p-perfil__data-item">
              <dt>Teléfono</dt>
              <dd>{{ usuario()?.telefono || 'No especificado' }}</dd>
            </div>
          </dl>
        </section>
      </div>
    </app-card>
  } @else {
    <!-- Vista de edición -->
    <app-card class="p-perfil__card">
      <header class="p-perfil__edit-header">
        <h2 class="p-perfil__edit-titulo">Editar información</h2>
      </header>

      <!-- Sección de Avatar -->
      <section class="p-perfil__avatar-section">
        <h3 class="p-perfil__avatar-titulo">Foto de perfil</h3>

        <div class="p-perfil__avatar-upload">
          <div class="p-perfil__avatar-current">
            @if (avatarPreview()) {
              <img [src]="avatarPreview()!" alt="Preview" class="p-perfil__avatar-preview" />
            } @else {
              <app-avatar
                [src]="usuario()?.avatar ?? ''"
                [name]="usuario()?.nombre ?? 'Usuario'"
                size="xl" />
            }
          </div>

          <div class="p-perfil__avatar-actions">
            @if (!avatarPreview()) {
              <label class="p-perfil__avatar-label">
                <app-icon name="upload" size="sm" aria-hidden="true" />
                <span>Subir nueva foto</span>
                <input
                  type="file"
                  accept="image/jpeg,image/png,image/webp"
                  (change)="onAvatarFileSelected($event)"
                  class="p-perfil__avatar-input"
                  [disabled]="isUploadingAvatar()" />
              </label>
              @if (hasCustomAvatar()) {
                <app-button
                  variant="yellow"
                  size="sm"
                  leftIcon="bin"
                  (click)="onDeleteAvatar()"
                  [loading]="isDeletingAvatar()"
                  [disabled]="isDeletingAvatar()">
                  Eliminar foto
                </app-button>
              }
              <p class="p-perfil__avatar-hint">
                JPG, PNG o WebP. Máximo 5MB. Se optimizará automáticamente.
              </p>
            } @else {
              <div class="p-perfil__avatar-preview-actions">
                <app-button
                  variant="primary"
                  size="sm"
                  leftIcon="check"
                  (click)="onUploadAvatar()"
                  [loading]="isUploadingAvatar()"
                  [disabled]="isUploadingAvatar()">
                  Guardar foto
                </app-button>
                <app-button
                  variant="ghost"
                  size="sm"
                  leftIcon="x"
                  (click)="onCancelAvatarUpload()"
                  [disabled]="isUploadingAvatar()">
                  Cancelar
                </app-button>
              </div>
            }
          </div>
        </div>
      </section>

      <form 
        [formGroup]="perfilForm" 
        (ngSubmit)="onSave()" 
        class="p-perfil__form"
        aria-label="Formulario de edición de perfil">
        <div class="p-perfil__form-fields">
          <app-form-input
            formControlName="nombre"
            label="Nombre completo"
            type="text"
            placeholder="Ingresa tu nombre completo"
            [required]="true"
            helperText="Entre 2 y 100 caracteres"
            autocomplete="name" />

          <app-form-input
            formControlName="telefono"
            label="Teléfono"
            type="tel"
            placeholder="+34 612 345 678"
            helperText="Opcional - Formato internacional"
            autocomplete="tel" />

          <div class="p-perfil__campo-readonly">
            <label class="p-perfil__etiqueta">Correo electrónico</label>
            <output class="p-perfil__valor-readonly">
              <app-icon name="lock" size="sm" aria-hidden="true" />
              {{ usuario()?.email ?? 'No especificado' }}
            </output>
            <p class="p-perfil__ayuda">El correo no se puede cambiar</p>
          </div>
        </div>

        <footer class="p-perfil__form-actions">
          <app-button
            type="button"
            variant="ghost"
            (click)="onCancel()"
            [disabled]="isSaving()">
            Cancelar
          </app-button>
          <app-button
            type="submit"
            variant="primary"
            leftIcon="check"
            [disabled]="!canSubmit()"
            [loading]="isSaving()">
            Guardar cambios
          </app-button>
        </footer>
      </form>
    </app-card>
  }

  @if (isSaving()) {
    <app-spinner-overlay />
  }
</article>
