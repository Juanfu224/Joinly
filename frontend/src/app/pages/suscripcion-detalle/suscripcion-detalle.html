<section class="p-suscripcion-detalle">
  <div class="l-contenedor">
    <!-- Estado de error -->
    @if (error()) {
      <div class="p-suscripcion-detalle__error" role="alert" aria-label="Error al cargar">
        <div class="p-suscripcion-detalle__error-content">
          <app-icon name="alert-triangle" size="lg" />
          <p class="p-suscripcion-detalle__error-message">{{ error() }}</p>
          <app-button variant="primary" (click)="onReintentar()">
            Reintentar
          </app-button>
        </div>
      </div>
    } @else if (suscripcion()) {
      <!-- Header -->
      <header class="p-suscripcion-detalle__header">
        <div class="p-suscripcion-detalle__header-content">
          <h1 class="p-suscripcion-detalle__title">{{ tituloSuscripcion() }}</h1>
          <p class="p-suscripcion-detalle__description">{{ descripcionSuscripcion() }}</p>
        </div>
        @if (puedeSolicitarPlaza()) {
          <div class="p-suscripcion-detalle__actions">
            <app-button
              variant="primary"
              leftIcon="add"
              (click)="onSolicitarPlaza()">
              Solicitar plaza
            </app-button>
          </div>
        }
        @if (estaCompleta() && !esMiembro() && !esAnfitrion()) {
          <div class="p-suscripcion-detalle__complete-notice">
            <app-icon name="users" size="sm" />
            <span>Esta suscripción está completa</span>
          </div>
        }
        @if (tieneSolicitudPendiente() && !esMiembro()) {
          <div class="p-suscripcion-detalle__pending-notice">
            <app-icon name="clock" size="sm" />
            <span>Tienes una solicitud pendiente de aprobación</span>
          </div>
        }
      </header>

      <!-- Stat Cards -->
      <div class="p-suscripcion-detalle__stats">
        @for (stat of statCards(); track stat.tipo) {
          <app-subscription-stat-card
            [tipo]="stat.tipo"
            [titulo]="stat.titulo"
            [valor]="stat.valor" />
        }
      </div>

      <!-- Miembros -->
      <app-member-list
        [members]="miembrosData()"
        [titulo]="'Miembros'"
        class="p-suscripcion-detalle__members" />

      <!-- Solicitudes pendientes - Solo visible para anfitriones -->
      @if (esAnfitrion() && solicitudesPendientes().length > 0) {
        <section class="p-suscripcion-detalle__solicitudes">
          <app-pending-requests-card
            [solicitudes]="solicitudesPendientesVisible()"
            (acceptRequest)="onAceptarSolicitud($event)"
            (rejectRequest)="onRechazarSolicitud($event)"
          />
          @if (hasMoreSolicitudes() && !loadingMoreSolicitudes()) {
            <div class="p-suscripcion-detalle__infinite-scroll-trigger" appInfiniteScroll (scrolled)="onLoadMoreSolicitudes()"></div>
          }
          @if (loadingMoreSolicitudes()) {
            <div class="p-suscripcion-detalle__loading-more">Cargando más solicitudes...</div>
          }
        </section>
      }

      <!-- Info Card - Solo visible para miembros de la suscripción -->
      @if (esMiembro() || esAnfitrion()) {
        <app-subscription-info-card
          [info]="infoData()"
          [isAdmin]="false"
          class="p-suscripcion-detalle__info" />
      }
    }
  </div>
</section>
