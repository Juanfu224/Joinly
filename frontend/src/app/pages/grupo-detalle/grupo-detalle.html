<main class="p-grupo-detalle">
  <div class="l-contenedor">
    <!-- Estado de carga -->
    @if (isLoading()) {
      <div class="p-grupo-detalle__loading" aria-label="Cargando grupo">
        <!-- Skeleton header -->
        <div class="p-grupo-detalle__skeleton-header">
          <div class="p-grupo-detalle__skeleton-titulo"></div>
          <div class="p-grupo-detalle__skeleton-subtitulo"></div>
        </div>
        <!-- Skeleton miembros -->
        <div class="p-grupo-detalle__skeleton-seccion"></div>
        <!-- Skeleton suscripciones -->
        <div class="p-grupo-detalle__skeleton-seccion p-grupo-detalle__skeleton-seccion--grande"></div>
      </div>
    } @else if (error()) {
      <!-- Estado de error -->
      <section class="p-grupo-detalle__error" aria-label="Error al cargar">
        <div class="p-grupo-detalle__error-content">
          <app-icon name="alert-triangle" size="lg" />
          <p class="p-grupo-detalle__error-text">{{ error() }}</p>
          <app-button variant="primary" (click)="onReintentar()">
            Reintentar
          </app-button>
        </div>
      </section>
    } @else {
      <!-- Header del grupo -->
      <header class="p-grupo-detalle__header">
        <div class="p-grupo-detalle__header-info">
          <h1 class="p-grupo-detalle__titulo">{{ grupo()?.nombre }}</h1>
          <p class="p-grupo-detalle__subtitulo">
            Gestiona suscripciones o crea alguna
          </p>
        </div>
        <app-button 
          variant="blue" 
          leftIcon="add"
          (click)="onInvitar()"
        >
          Invitar
        </app-button>
      </header>

      <!-- Sección de miembros -->
      <section class="p-grupo-detalle__miembros" aria-labelledby="titulo-miembros">
        <app-member-list [members]="membersData()" />
      </section>

      <!-- Sección de solicitudes pendientes (solo para admin) -->
      @if (isAdmin() && hasSolicitudesPendientes()) {
        <section class="p-grupo-detalle__solicitudes" aria-labelledby="titulo-solicitudes">
          <app-pending-requests-card
            [solicitudes]="solicitudesPendientesVisible()"
            (acceptRequest)="onAceptarSolicitud($event)"
            (rejectRequest)="onRechazarSolicitud($event)"
          />
          @if (hasMoreSolicitudes() && !loadingMoreSolicitudes()) {
            <div class="p-grupo-detalle__infinite-scroll-trigger" appInfiniteScroll (scrolled)="onLoadMoreSolicitudes()"></div>
          }
          @if (loadingMoreSolicitudes()) {
            <div class="p-grupo-detalle__loading-more">Cargando más solicitudes...</div>
          }
        </section>
      }

      <!-- Sección de suscripciones -->
      <section class="p-grupo-detalle__suscripciones" aria-labelledby="titulo-suscripciones">
        <header class="p-grupo-detalle__suscripciones-header">
          <h2 id="titulo-suscripciones" class="p-grupo-detalle__suscripciones-titulo">
            Tus suscripciones
          </h2>
          <app-button 
            variant="purple"
            (click)="onCrearSuscripcion()"
          >
            Crear suscripción
          </app-button>
        </header>

        <!-- Filtros de suscripciones -->
        @if (hasSuscripciones()) {
          <div class="p-grupo-detalle__filtros">
            <div class="p-grupo-detalle__filtros-label">Filtros:</div>
            <div class="p-grupo-detalle__filtros-chips">
              @for (estado of ESTADOS; track estado) {
                <button
                  type="button"
                  class="p-grupo-detalle__filtro-chip"
                  [class.p-grupo-detalle__filtro-chip--active]="estadosFiltro().includes(estado)"
                  (click)="toggleEstadoFiltro(estado)"
                  aria-pressed="estadosFiltro().includes(estado)"
                >
                  {{ estado.toLowerCase() }}
                </button>
              }
            </div>
            <div class="p-grupo-detalle__filtros-periodicidad">
              <select
                class="p-grupo-detalle__filtro-select"
                [value]="periodicidadFiltro() ?? ''"
                (change)="onPeriodicidadChange($event)"
                aria-label="Filtrar por periodicidad"
              >
                <option value="">Todas las periodicidades</option>
                @for (p of PERIODICIDADES; track p) {
                  <option [value]="p">{{ p.toLowerCase() }}</option>
                }
              </select>
            </div>
            @if (hasFiltrosActivos()) {
              <button
                type="button"
                class="p-grupo-detalle__filtros-clear"
                (click)="clearFiltros()"
                aria-label="Limpiar filtros"
              >
                <app-icon name="x" size="sm" />
                Limpiar
              </button>
            }
          </div>
        }

        <div class="p-grupo-detalle__suscripciones-content">
          @if (noFilterResults()) {
            <div class="p-grupo-detalle__no-results">
              <app-icon name="filter" size="lg" />
              <p>No hay suscripciones que coincidan con los filtros aplicados</p>
              <button type="button" class="p-grupo-detalle__clear-filters" (click)="clearFiltros()">
                Limpiar filtros
              </button>
            </div>
          } @else if (hasSuscripciones()) {
            <div class="p-grupo-detalle__suscripciones-grid">
              @for (suscripcion of suscripcionesFiltradasCards(); track suscripcion.id) {
                <app-subscription-card
                  [suscripcion]="suscripcion"
                  (viewDetails)="onSuscripcionClick(suscripcion.id)"
                />
              }
            </div>
            @if (suscripcionesFiltradas().length > suscripcionesPageSize()) {
              <div class="p-grupo-detalle__pagination">
                <app-pagination
                  [currentPage]="paginationInfo().currentPage"
                  [totalItems]="paginationInfo().totalItems"
                  [pageSize]="paginationInfo().pageSize"
                  (pageChange)="onPageChange($event)"
                />
              </div>
            }
          } @else {
            <app-empty-subscriptions />
          }
        </div>
      </section>
    }
  </div>
</main>
