<app-form-card
  title="Nueva suscripción"
  description="Comparte un servicio en tu grupo"
  logoVariant="morado"
>
  <form class="c-new-subscription-form__form" [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
    <!-- Sección: Datos del servicio -->
    <fieldset class="c-new-subscription-form__fieldset">
      <legend class="c-new-subscription-form__legend">Datos del servicio</legend>

      <app-form-input
        #nombreInput
        label="Nombre del servicio"
        type="text"
        name="nombre"
        autocomplete="off"
        placeholder="Ej: Netflix Premium, Spotify Family..."
        [required]="true"
        formControlName="nombre"
        [errorMessage]="getErrorMessage('nombre')"
      />

      <div class="c-new-subscription-form__row">
        <app-form-input
          #precioInput
          label="Precio total (€)"
          type="number"
          name="precioTotal"
          autocomplete="off"
          placeholder="Mensual o Anual"
          [required]="true"
          formControlName="precioTotal"
          [errorMessage]="getErrorMessage('precioTotal')"
        />

        <app-form-input
          #plazasInput
          label="Numero de plazas"
          type="number"
          name="plazas"
          autocomplete="off"
          placeholder="Incluida la tuya"
          [required]="true"
          formControlName="plazas"
          [errorMessage]="getErrorMessage('plazas')"
        />
      </div>
    </fieldset>

    <!-- Sección: Credenciales de acceso -->
    <fieldset class="c-new-subscription-form__fieldset">
      <legend class="c-new-subscription-form__legend-visible">Credenciales de acceso</legend>
      <p class="c-new-subscription-form__help-text">
        Agrega las credenciales que los miembros necesitarán para acceder al servicio
      </p>

      <div class="c-new-subscription-form__credentials">
        @for (credencial of credenciales.controls; track $index; let i = $index) {
          <app-form-array-item
            [title]="'Credencial ' + (i + 1)"
            [canRemove]="credenciales.length > 1"
            (removed)="removeCredencial(i)"
          >
            <app-credential-input-group
              [formGroup]="$any(credencial)"
              [index]="i"
            />
          </app-form-array-item>
        }
      </div>

      <app-button
        type="button"
        variant="secondary"
        size="md"
        (click)="addCredencial()"
        [disabled]="credenciales.length >= 10"
      >
        <app-icon name="add" />
        Añadir credencial
      </app-button>
    </fieldset>

    @if (formError()) {
      <div class="c-new-subscription-form__error" role="alert">
        {{ formError() }}
      </div>
    }

    @for (error of getFormErrorMessages(); track error) {
      <div class="c-new-subscription-form__error" role="alert">
        {{ error }}
      </div>
    }

    <div class="c-new-subscription-form__actions">
      <app-button
        type="button"
        variant="secondary"
        size="xl"
        (click)="onCancel()"
      >
        Cancelar
      </app-button>

      <app-button
        type="submit"
        variant="purple"
        size="xl"
        [disabled]="isFormInvalid() || form.pending || isLoading()"
        [loading]="isLoading()"
      >
        @if (isLoading()) { Creando... }
        @else if (form.pending) { Validando... }
        @else { Crear }
      </app-button>
    </div>
  </form>
</app-form-card>
